# Cerberus AI Code Review â€” Reusable Workflow
# https://github.com/misty-step/cerberus
#
# Minimal consumer usage (~13 lines):
#
#   name: Cerberus
#   on:
#     pull_request:
#       types: [opened, synchronize, reopened]
#   permissions:
#     contents: read
#     pull-requests: write
#   jobs:
#     review:
#       uses: misty-step/cerberus/.github/workflows/cerberus.yml@v2
#       secrets:
#         api-key: ${{ secrets.OPENROUTER_API_KEY }}
#
# Inputs and the decomposed-pipeline power-user option:
#   See templates/consumer-workflow.yml (recommended) and
#   templates/consumer-workflow-minimal.yml (decomposed pipeline)
name: Cerberus AI Code Review

on:
  workflow_call:
    inputs:
      timeout:
        description: 'Max seconds per reviewer'
        type: number
        default: 600
      model:
        description: 'LLM model override for all reviewers (pins models; Cerberus will warn)'
        type: string
        required: false
      context:
        description: 'Project/domain context for reviewers. Helps calibrate severity. Do not include secrets.'
        type: string
        required: false
      reviewers:
        description: 'Comma-separated reviewer override (bypasses LLM routing). Example: trace,guard,craft'
        type: string
        required: false
      fail-on-verdict:
        description: 'Fail the workflow when Cerberus verdict is FAIL'
        type: string
        default: 'true'
      fail-on-skip:
        description: 'Fail the workflow when Cerberus verdict is SKIP (all reviews skipped)'
        type: string
        default: 'false'
    secrets:
      api-key:
        description: 'OpenRouter API key'
        required: true

jobs:
  preflight:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    outputs:
      should_run: ${{ steps.preflight.outputs.should_run }}
    steps:
      - uses: misty-step/cerberus/preflight@v2
        id: preflight
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.api-key }}

  route:
    needs: preflight
    if: needs.preflight.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      panel: ${{ steps.router.outputs.panel }}
    steps:
      - name: Fetch PR diff
        # gh is pre-installed on GitHub-hosted runners; no checkout needed
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr.diff
      - uses: misty-step/cerberus/router@v2
        id: router
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.api-key }}
          diff-file: /tmp/pr.diff
          reviewers: ${{ inputs.reviewers }}

  matrix:
    needs: route
    if: needs.preflight.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - uses: misty-step/cerberus/matrix@v2
        id: generate
        with:
          panel: ${{ needs.route.outputs.panel }}

  review:
    needs: [matrix, preflight]
    if: needs.preflight.outputs.should_run == 'true'
    name: "${{ matrix.reviewer_label || matrix.reviewer }}"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    strategy:
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: misty-step/cerberus@v2
        with:
          perspective: ${{ matrix.perspective }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.api-key }}
          timeout: ${{ inputs.timeout }}
          model: ${{ inputs.model }}
          context: ${{ inputs.context }}

  verdict:
    name: "Verdict"
    needs: [review, preflight]
    if: always() && needs.review.result != 'skipped' && needs.preflight.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: misty-step/cerberus/verdict@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-verdict: ${{ inputs.fail-on-verdict }}
          fail-on-skip: ${{ inputs.fail-on-skip }}
