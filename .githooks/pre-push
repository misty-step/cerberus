#!/bin/bash
#
# Pre-push hook for Cerberus
# Thorough checks (<60s) before pushing
#

set -euo pipefail

echo "ðŸ” Running pre-push checks..."
start_time=$(date +%s)

# Check 1: Run full pytest suite
echo "  â†’ Running full test suite..."
if command -v python3 >/dev/null 2>&1 && python3 -c "import pytest" 2>/dev/null; then
    timeout_flag=""
    python3 -c "import pytest_timeout" 2>/dev/null && timeout_flag="--timeout=30"
    # shellcheck disable=SC2086
    if python3 -m pytest tests/ -x $timeout_flag -q; then
        echo "    âœ“ All tests passed"
    else
        echo "    âœ— Tests failed - push blocked"
        exit 1
    fi
else
    echo "    âš  Python3 or pytest not available, skipping tests"
fi

# Check 2: Run shellcheck on ALL shell scripts (scripts/ and tests/)
echo "  â†’ Running shellcheck on all shell scripts..."
if command -v shellcheck >/dev/null 2>&1; then
    sh_scripts=$(find scripts tests -name "*.sh" -type f 2>/dev/null || true)
    if [ -n "$sh_scripts" ]; then
        script_count=$(echo "$sh_scripts" | wc -l | tr -d ' ')
        # Batch into single shellcheck invocation
        if ! echo "$sh_scripts" | tr '\n' '\0' | xargs -0 shellcheck; then
            echo "    âœ— shellcheck failed - push blocked"
            exit 1
        else
            echo "    âœ“ All shell scripts passed ($script_count file(s))"
        fi
    else
        echo "    âœ“ No shell scripts found"
    fi
else
    echo "    âš  shellcheck not installed, skipping"
fi

# Check 3: Run ruff on all Python files (blocking)
echo "  â†’ Running ruff check on all Python files..."
if command -v ruff >/dev/null 2>&1; then
    ruff_paths=()
    [ -d "scripts" ] && ruff_paths+=("scripts/")
    [ -d "tests" ] && ruff_paths+=("tests/")
    [ -d "matrix" ] && ruff_paths+=("matrix/")
    if [ ${#ruff_paths[@]} -gt 0 ]; then
        if ruff check "${ruff_paths[@]}"; then
            echo "    âœ“ All Python files passed ruff"
        else
            echo "    âœ— ruff found errors - push blocked"
            exit 1
        fi
    fi
else
    echo "    âš  ruff not installed, skipping"
fi

end_time=$(date +%s)
duration=$((end_time - start_time))

echo ""
echo "âœ“ All pre-push checks passed (${duration}s)"
exit 0
