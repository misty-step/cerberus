#!/bin/bash
#
# Pre-push hook for Cerberus
# Thorough checks (<60s) before pushing
#

set -euo pipefail

echo "ðŸ” Running pre-push checks..."
start_time=$(date +%s)

# Check 1: Run full pytest suite
echo "  â†’ Running full test suite (pytest -x --timeout=30)..."
if command -v python3 >/dev/null 2>&1; then
    if python3 -m pytest tests/ -x --timeout=30 -q; then
        echo "    âœ“ All tests passed"
    else
        echo "    âœ— Tests failed - push blocked"
        exit 1
    fi
else
    echo "    âš  Python3 not available, skipping tests"
fi

# Check 2: Run shellcheck on ALL shell scripts (not just staged)
echo "  â†’ Running shellcheck on all shell scripts..."
if command -v shellcheck >/dev/null 2>&1; then
    sh_scripts=$(find scripts -name "*.sh" -type f 2>/dev/null || true)
    if [ -n "$sh_scripts" ]; then
        sc_errors=0
        for script in $sh_scripts; do
            if ! shellcheck "$script"; then
                echo "    âœ— shellcheck failed: $script"
                sc_errors=$((sc_errors + 1))
            fi
        done
        if [ $sc_errors -gt 0 ]; then
            echo "    âœ— $sc_errors shell script(s) failed - push blocked"
            exit 1
        else
            echo "    âœ“ All shell scripts passed ($(echo "$sh_scripts" | wc -w) file(s))"
        fi
    fi
else
    echo "    âš  shellcheck not installed, skipping"
fi

# Check 3: Run ruff on all Python files
echo "  â†’ Running ruff check on all Python files..."
if command -v ruff >/dev/null 2>&1; then
    py_files=$(find scripts -name "*.py" -type f 2>/dev/null || true)
    if [ -n "$py_files" ]; then
        if ruff check --select E,W,F --ignore E501 scripts/; then
            echo "    âœ“ All Python files passed ruff"
        else
            echo "    ! ruff found issues (non-blocking)"
        fi
    fi
else
    echo "    âš  ruff not installed, skipping"
fi

end_time=$(date +%s)
duration=$((end_time - start_time))

echo ""
echo "âœ“ All pre-push checks passed (${duration}s)"
exit 0
