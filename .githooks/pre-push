#!/bin/bash
#
# Pre-push hook for Cerberus
# Thorough checks (<60s) before pushing
#

set -euo pipefail

echo "ðŸ” Running pre-push checks..."
start_time=$(date +%s)

# Check 1: Run full pytest suite
echo "  â†’ Running full test suite (pytest -x --timeout=30)..."
if command -v python3 >/dev/null 2>&1 && python3 -c "import pytest" 2>/dev/null; then
    if python3 -m pytest tests/ -x --timeout=30 -q; then
        echo "    âœ“ All tests passed"
    else
        echo "    âœ— Tests failed - push blocked"
        exit 1
    fi
else
    echo "    âš  Python3 or pytest not available, skipping tests"
fi

# Check 2: Run shellcheck on ALL shell scripts (not just staged)
echo "  â†’ Running shellcheck on all shell scripts..."
if command -v shellcheck >/dev/null 2>&1; then
    sc_errors=0
    while IFS= read -r script; do
        if ! shellcheck "$script" 2>/dev/null; then
            echo "    âœ— shellcheck failed: $script"
            sc_errors=$((sc_errors + 1))
        fi
    done < <(find scripts -name "*.sh" -type f 2>/dev/null)
    if [ $sc_errors -gt 0 ]; then
        echo "    âœ— $sc_errors shell script(s) failed - push blocked"
        exit 1
    else
        script_count=$(find scripts -name "*.sh" -type f 2>/dev/null | wc -l | tr -d ' ')
        echo "    âœ“ All shell scripts passed ($script_count file(s))"
    fi
else
    echo "    âš  shellcheck not installed, skipping"
fi

# Check 3: Run ruff on all Python files
echo "  â†’ Running ruff check on all Python files..."
if command -v ruff >/dev/null 2>&1; then
    if [ -d "scripts" ]; then
        if ruff check --select E,W,F --ignore E501 scripts/ 2>/dev/null; then
            echo "    âœ“ All Python files passed ruff"
        else
            echo "    ! ruff found issues (non-blocking)"
        fi
    fi
else
    echo "    âš  ruff not installed, skipping"
fi

end_time=$(date +%s)
duration=$((end_time - start_time))

echo ""
echo "âœ“ All pre-push checks passed (${duration}s)"
exit 0
