#!/bin/bash
#
# Pre-commit hook for Cerberus
# Fast checks (<5s) on staged files only
#

set -euo pipefail

echo "ðŸ” Running pre-commit checks..."

# Get list of staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$staged_files" ]; then
    echo "âœ“ No staged files to check"
    exit 0
fi

errors=0

# Check shell scripts (*.sh) â€” batched into single shellcheck invocation
if command -v shellcheck >/dev/null 2>&1; then
    sh_files=$(echo "$staged_files" | grep '\.sh$' || true)
    if [ -n "$sh_files" ]; then
        echo "  â†’ Checking shell scripts with shellcheck..."
        files_to_check=()
        while IFS= read -r file; do
            [ -f "$file" ] && files_to_check+=("$file")
        done <<< "$sh_files"
        if [ ${#files_to_check[@]} -gt 0 ]; then
            if ! shellcheck "${files_to_check[@]}"; then
                echo "    âœ— shellcheck failed"
                errors=$((errors + 1))
            else
                echo "    âœ“ shellcheck passed"
            fi
        fi
    fi
else
    echo "  â†’ shellcheck not installed, skipping shell script checks"
fi

# Check all staged Python files (scripts/, matrix/, tests/, etc.)
py_files=$(echo "$staged_files" | grep '\.py$' || true)
if [ -n "$py_files" ]; then
    py_to_check=()
    while IFS= read -r file; do
        [ -f "$file" ] && py_to_check+=("$file")
    done <<< "$py_files"

    if [ ${#py_to_check[@]} -gt 0 ]; then
        # Syntax check â€” batched py_compile
        echo "  â†’ Checking Python syntax..."
        if ! python3 -m py_compile "${py_to_check[@]}"; then
            echo "    âœ— Python syntax errors found"
            errors=$((errors + 1))
        else
            echo "    âœ“ Python syntax OK"
        fi

        # Ruff lint (blocking)
        if command -v ruff >/dev/null 2>&1; then
            echo "  â†’ Running ruff check..."
            if ! ruff check "${py_to_check[@]}"; then
                echo "    âœ— ruff found errors"
                errors=$((errors + 1))
            else
                echo "    âœ“ ruff clean"
            fi
        fi
    fi
fi

# Check YAML files (only if PyYAML is installed)
yaml_files=$(echo "$staged_files" | grep -E '\.(yml|yaml)$' || true)
if [ -n "$yaml_files" ]; then
    if python3 -c "import yaml" 2>/dev/null; then
        echo "  â†’ Checking YAML files..."
        while IFS= read -r file; do
            if [ -f "$file" ]; then
                if ! python3 -c "import sys, yaml; yaml.safe_load(open(sys.argv[1]))" "$file"; then
                    echo "    âœ— Invalid YAML: $file"
                    errors=$((errors + 1))
                else
                    echo "    âœ“ $file"
                fi
            fi
        done <<< "$yaml_files"
    else
        echo "  â†’ PyYAML not installed, skipping YAML validation"
    fi
fi

# Check JSON files
json_files=$(echo "$staged_files" | grep '\.json$' || true)
if [ -n "$json_files" ]; then
    echo "  â†’ Checking JSON files..."
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            if ! python3 -c "import sys, json; json.load(open(sys.argv[1]))" "$file"; then
                echo "    âœ— Invalid JSON: $file"
                errors=$((errors + 1))
            else
                echo "    âœ“ $file"
            fi
        fi
    done <<< "$json_files"
fi

if [ $errors -gt 0 ]; then
    echo ""
    echo "âœ— Pre-commit checks failed with $errors error(s)"
    exit 1
fi

file_count=$(printf '%s' "$staged_files" | grep -c . || echo 0)
echo "âœ“ All pre-commit checks passed ($file_count file(s) checked)"
exit 0
