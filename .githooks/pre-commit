#!/bin/bash
#
# Pre-commit hook for Cerberus
# Fast checks (<5s) on staged files only
#

set -euo pipefail

echo "ðŸ” Running pre-commit checks..."

# Get list of staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$staged_files" ]; then
    echo "âœ“ No staged files to check"
    exit 0
fi

errors=0

# Check shell scripts (*.sh) â€” batched into single shellcheck invocation
if command -v shellcheck >/dev/null 2>&1; then
    sh_files=$(echo "$staged_files" | grep '\.sh$' || true)
    if [ -n "$sh_files" ]; then
        echo "  â†’ Checking shell scripts with shellcheck..."
        files_to_check=()
        while IFS= read -r file; do
            [ -f "$file" ] && files_to_check+=("$file")
        done <<< "$sh_files"
        if [ ${#files_to_check[@]} -gt 0 ]; then
            if ! shellcheck "${files_to_check[@]}"; then
                echo "    âœ— shellcheck failed"
                errors=$((errors + 1))
            else
                echo "    âœ“ shellcheck passed"
            fi
        fi
    fi
else
    echo "  â†’ shellcheck not installed, skipping shell script checks"
fi

# Check all staged Python files (scripts/, matrix/, tests/, etc.)
py_files=$(echo "$staged_files" | grep '\.py$' || true)
if [ -n "$py_files" ]; then
    py_to_check=()
    while IFS= read -r file; do
        [ -f "$file" ] && py_to_check+=("$file")
    done <<< "$py_files"

    if [ ${#py_to_check[@]} -gt 0 ]; then
        # Syntax check â€” batched py_compile
        echo "  â†’ Checking Python syntax..."
        if ! python3 -m py_compile "${py_to_check[@]}"; then
            echo "    âœ— Python syntax errors found"
            errors=$((errors + 1))
        else
            echo "    âœ“ Python syntax OK"
        fi

        # Ruff lint (blocking)
        if command -v ruff >/dev/null 2>&1; then
            echo "  â†’ Running ruff check..."
            if ! ruff check "${py_to_check[@]}"; then
                echo "    âœ— ruff found errors"
                errors=$((errors + 1))
            else
                echo "    âœ“ ruff clean"
            fi
        fi
    fi
fi

# Check YAML files (only if PyYAML is installed)
yaml_files=$(echo "$staged_files" | grep -E '\.(yml|yaml)$' || true)
if [ -n "$yaml_files" ]; then
    if python3 -c "import yaml" 2>/dev/null; then
        yaml_to_check=()
        while IFS= read -r file; do
            [ -f "$file" ] && yaml_to_check+=("$file")
        done <<< "$yaml_files"

        echo "  â†’ Checking YAML files..."
        if [ ${#yaml_to_check[@]} -gt 0 ]; then
            if ! python3 - "${yaml_to_check[@]}" <<'PY'
import sys
import yaml

failed = False

for path in sys.argv[1:]:
    try:
        with open(path) as f:
            yaml.safe_load(f)
        print(f"    âœ“ {path}")
    except Exception:
        print(f"    âœ— Invalid YAML: {path}")
        failed = True

sys.exit(1 if failed else 0)
PY
            then
                errors=$((errors + 1))
            fi
        fi
    else
        echo "  â†’ PyYAML not installed, skipping YAML validation"
    fi
fi

# Check JSON files
json_files=$(echo "$staged_files" | grep '\.json$' || true)
if [ -n "$json_files" ]; then
    echo "  â†’ Checking JSON files..."
    json_to_check=()
    while IFS= read -r file; do
        [ -f "$file" ] && json_to_check+=("$file")
    done <<< "$json_files"

    if [ ${#json_to_check[@]} -gt 0 ]; then
        if ! python3 - "${json_to_check[@]}" <<'PY'
import json
import sys

failed = False

for path in sys.argv[1:]:
    try:
        with open(path) as f:
            json.load(f)
        print(f"    âœ“ {path}")
    except Exception:
        print(f"    âœ— Invalid JSON: {path}")
        failed = True

sys.exit(1 if failed else 0)
PY
        then
            errors=$((errors + 1))
        fi
    fi
fi

if [ $errors -gt 0 ]; then
    echo ""
    echo "âœ— Pre-commit checks failed with $errors error(s)"
    exit 1
fi

file_count=$(printf '%s' "$staged_files" | grep -c . || echo 0)
echo "âœ“ All pre-commit checks passed ($file_count file(s) checked)"
exit 0
