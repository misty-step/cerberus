#!/bin/bash
#
# Pre-commit hook for Cerberus
# Fast checks (<5s) on staged files only
#

set -euo pipefail

echo "ðŸ” Running pre-commit checks..."

# Get list of staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$staged_files" ]; then
    echo "âœ“ No staged files to check"
    exit 0
fi

errors=0

# Check shell scripts (*.sh) - only if shellcheck is installed
if command -v shellcheck >/dev/null 2>&1; then
    sh_files=$(echo "$staged_files" | grep '\.sh$' || true)
    if [ -n "$sh_files" ]; then
        echo "  â†’ Checking shell scripts with shellcheck..."
        while IFS= read -r file; do
            if [ -f "$file" ]; then
                if ! shellcheck "$file" 2>/dev/null; then
                    echo "    âœ— shellcheck failed: $file"
                    errors=$((errors + 1))
                else
                    echo "    âœ“ $file"
                fi
            fi
        done <<< "$sh_files"
    fi
else
    echo "  â†’ shellcheck not installed, skipping shell script checks"
fi

# Check Python files in scripts/ and scripts/lib/
py_files=$(echo "$staged_files" | grep -E '^scripts/.*\.py$' || true)
if [ -n "$py_files" ]; then
    echo "  â†’ Checking Python syntax with py_compile..."
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            if ! python3 -m py_compile "$file" 2>/dev/null; then
                echo "    âœ— Syntax error in: $file"
                errors=$((errors + 1))
            else
                echo "    âœ“ $file"
            fi
        fi
    done <<< "$py_files"

    # Run ruff lint on all staged Python files at once (if available)
    if command -v ruff >/dev/null 2>&1; then
        echo "  â†’ Running ruff check (lint only)..."
        # shellcheck disable=SC2086
        if ! ruff check --select E,W,F --ignore E501 $py_files 2>/dev/null; then
            echo "    ! ruff found warnings (non-blocking)"
        else
            echo "    âœ“ ruff clean"
        fi
    fi
fi

# Check YAML files
yaml_files=$(echo "$staged_files" | grep -E '\.(yml|yaml)$' || true)
if [ -n "$yaml_files" ]; then
    echo "  â†’ Checking YAML files..."
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            if ! python3 -c "import sys, yaml; yaml.safe_load(open(sys.argv[1]))" "$file" 2>/dev/null; then
                echo "    âœ— Invalid YAML: $file"
                errors=$((errors + 1))
            else
                echo "    âœ“ $file"
            fi
        fi
    done <<< "$yaml_files"
fi

# Check JSON files (specifically opencode.json)
json_files=$(echo "$staged_files" | grep '\.json$' || true)
if [ -n "$json_files" ]; then
    echo "  â†’ Checking JSON files..."
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            if ! python3 -c "import sys, json; json.load(open(sys.argv[1]))" "$file" 2>/dev/null; then
                echo "    âœ— Invalid JSON: $file"
                errors=$((errors + 1))
            else
                echo "    âœ“ $file"
            fi
        fi
    done <<< "$json_files"
fi

if [ $errors -gt 0 ]; then
    echo ""
    echo "âœ— Pre-commit checks failed with $errors error(s)"
    exit 1
fi

echo "âœ“ All pre-commit checks passed ($(echo "$staged_files" | wc -l | tr -d ' ') file(s) checked)"
exit 0
