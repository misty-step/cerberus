name: 'Cerberus Matrix'
description: 'Output the current Cerberus reviewer matrix from defaults/config.yml'
author: 'misty-step'

branding:
  icon: 'list'
  color: 'blue'

outputs:
  matrix:
    description: 'JSON matrix of reviewers for use in strategy.matrix'
    value: ${{ steps.generate.outputs.matrix }}
  count:
    description: 'Number of reviewers in the matrix'
    value: ${{ steps.generate.outputs.count }}
  reviewers:
    description: 'Comma-separated list of reviewer names'
    value: ${{ steps.generate.outputs.reviewers }}

runs:
  using: 'composite'
  steps:
    - name: Generate matrix from config
      id: generate
      shell: bash
      env:
        CERBERUS_ROOT: ${{ github.action_path }}/..
      run: |
        config_file="${CERBERUS_ROOT}/defaults/config.yml"

        if [[ ! -f "$config_file" ]]; then
          echo "::error::Config file not found: $config_file"
          exit 1
        fi

        pip install pyyaml --quiet

        python3 "${{ github.action_path }}/generate-matrix.py" "$config_file" > /dev/null

        matrix_json=$(cat /tmp/matrix-output.json)
        count=$(cat /tmp/matrix-count.txt)
        names=$(cat /tmp/matrix-names.txt)

        echo "matrix=$matrix_json" >> "$GITHUB_OUTPUT"
        echo "count=$count" >> "$GITHUB_OUTPUT"
        echo "reviewers=$names" >> "$GITHUB_OUTPUT"

        echo "Generated matrix with $count reviewers: $names"
