name: 'Cerberus Matrix'
description: 'Output the current Cerberus reviewer matrix from defaults/config.yml'
author: 'misty-step'

branding:
  icon: 'list'
  color: 'blue'

inputs:
  panel:
    description: 'JSON array of perspective strings to filter the matrix (from router). Empty = all reviewers.'
    default: ''

outputs:
  matrix:
    description: 'JSON matrix of reviewers for use in strategy.matrix'
    value: ${{ steps.generate.outputs.matrix }}
  count:
    description: 'Number of reviewers in the matrix'
    value: ${{ steps.generate.outputs.count }}
  reviewers:
    description: 'Comma-separated list of reviewer names'
    value: ${{ steps.generate.outputs.reviewers }}

runs:
  using: 'composite'
  steps:
    - name: Generate matrix from config
      id: generate
      shell: bash
      env:
        CERBERUS_ROOT: ${{ github.action_path }}/..
        PANEL_FILTER: ${{ inputs.panel }}
      run: |
        config_file="${CERBERUS_ROOT}/defaults/config.yml"

        if [[ ! -f "$config_file" ]]; then
          echo "::error::Config file not found: $config_file"
          exit 1
        fi

        pip install pyyaml --quiet

        python3 "${{ github.action_path }}/generate-matrix.py" "$config_file" > /dev/null

        if [[ -n "${PANEL_FILTER:-}" && "$PANEL_FILTER" != "[]" ]]; then
          python3 -c "
import json, sys
matrix = json.load(open('/tmp/matrix-output.json'))
panel = json.loads(sys.argv[1])
panel_set = set(panel)
filtered = [r for r in matrix['include'] if r['perspective'] in panel_set]
if not filtered:
    filtered = matrix['include']
    print('::warning::Panel filter matched no reviewers; using full matrix', file=sys.stderr)
json.dump({'include': filtered}, open('/tmp/matrix-output.json', 'w'))
open('/tmp/matrix-count.txt', 'w').write(str(len(filtered)))
open('/tmp/matrix-names.txt', 'w').write(','.join(r['reviewer'] for r in filtered))
" "$PANEL_FILTER"
        fi

        matrix_json=$(cat /tmp/matrix-output.json)
        count=$(cat /tmp/matrix-count.txt)
        names=$(cat /tmp/matrix-names.txt)

        echo "matrix=$matrix_json" >> "$GITHUB_OUTPUT"
        echo "count=$count" >> "$GITHUB_OUTPUT"
        echo "reviewers=$names" >> "$GITHUB_OUTPUT"

        echo "Generated matrix with $count reviewers: $names"
